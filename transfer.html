<script>
var querys = location.search.match(/session=([^&]+)&offer=([^&]+)&candidates=([^&]+)/);
var session = querys[1];
var offer = { type: "offer", sdp: decodeURI(querys[2]) };
var candidates = JSON.parse(querys[3]);
var connection = new RTCPeerConnection({
    iceServers: [{
        urls: [
            'stun:stun.l.google.com:19302',
            'stun:stun1.l.google.com:19302',
            'stun:stun2.l.google.com:19302',
            'stun:stun3.l.google.com:19302',
            'stun:stun4.l.google.com:19302'
        ]
    }]
});
var channel = connection.createDataChannel("channel");
connection.onicecandidate = evt => !evt.candidate || save('lpush', 'candidate', JSON.stringify(evt.candidate));
channel.onopen = () => readClipboard(text => channel.send(text));
channel.onclose = () => window.close();
connection.setRemoteDescription(offer)
    .then(() => connection.createAnswer())
    .then(answer => connection.setLocalDescription(answer))
    .then(() => {
        save('set', 'answer', connection.localDescription.sdp);
        candidates.forEach(candidate => connection.addIceCandidate(candidate));
    })
    .catch(err => {
        alert(err);
        window.close();
    });
function save(cmd, key, value) {
    fetch("https://try.redis.io/eval?command=" + cmd + "+" + key + "+'" + encodeURIComponent(value) + "'&session_id=" + session, {
        mode: 'no-cors'
    }).catch(err => {
        alert(err);
        window.close();
    });
}
function readClipboard(onread) {onread(12)
    function onpaste(evt) {
        evt.preventDefault();
        onread(evt.clipboardData.getData('text/plain'));
    }
    document.addEventListener('paste', onpaste);
    document.execCommand('paste');
    document.removeEventListener('paste', onpaste);
}
</script>
